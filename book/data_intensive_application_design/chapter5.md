### 다중 리더 복제

리더 기반 복제의 단점
- 리더가 하나만 존재하기에 모든 쓰기 요청이 리더를 거친다
- 클라이언트와 리더의 네트워크 통신이 단절되면 데이터베이스에 쓰기 작업을 할 수 없다

-> 필연적으로 리더를 여러대 두는 전략을 선택해야 한다.

단일 데이터 센터 내 다중 리더를 두는 것은 그 복잡도에 비해 효율이 좋지 않다

- 단일 리더 설정 : 하나의 데이터 센터에 리더가 있기에 모든 쓰기 요청이 해당 데이터센터로 유입되야 한다.
- 다중 리더 설정 : 하나의 데이터센터 내에서는 단일 리더 설정을 하고 데이터 센터간에는 하나의 리더가 다른 리더에게 변경 사항 복제한다

MySQL의 텅스텐 리플리케이터가 있다.

다중 리더 설정의 장점 :
- 성능
- 데이터센터 중단 내성 : 각 데이터센터가 독립적으로 동작한다.
- 네트워크 문제 내성 : 비동기 복제를 사용하면 일시적 네트워크 중단에도 쓰기 처리는 진행됨

다중 리더 설정의 단점 : 하나의 데이터를 두개의 데이터센터에서 같이 변경할 수 있다. 쓰기 충돌 해소시켜줘야 함

### 리더 없는 복제

리더 없는 복제는 AWS 내부 다이나모 시스템에서 사용 후, 이에 영감을 받은 여러 데이터 스토어가 생겨났기에 **다이나모 스타일**이라고 한다.

**리더 없는 복제 구현 방법**
- 클라이언트가 여러 복제 서버에 직접 쓰기 진행
- 코디네이션 노드가 클라이언트 대신 수행

리더 없는 복제에서의 노드 장애 대처 방법

- 리더 없는 복제는 장애복구를 하지 않는다

리더 없는 복제는 복제 서버들에 쓰기 작업을 병렬로 실행한다. 만약 쓰기 작업이 복제 서버에 도달했다면 OK 응답을 보내고 데이터의 버전을 증가시킨다. 

이 상황에서 장애가 발생한 노드는 쓰기 요청을 받지 못할 것이고, 데이터 업데이트가 누락된다. 그러면 차후 읽기 작업을 할때 이전 데이터를 보게 될 수 있다.

리더 없는 복제에서는 읽기 작업도 여러 노드에 병렬로 요청한다. 데이터가 최신인지 아닌지 여부는 버전값을 기준으로 판단한다.

### 최신 데이터가 누락된 복제 서버가 쓰기를 따라잡는 방법

두 가지 메커니즘이 활용된다
- 읽기 복구
- 안티 엔트로피 처리

**읽기 복구**

클라이언트는 읽기 요청을 여러 노드에게 병렬로 실행한다. 이때 버전이 낮은 노드가 발견되면 해당 노드에 최신 데이터를 입력한다. 이 방식은 값을 자주 읽는 상황에 적합함

**안티 엔트로피 처리**

백그라운드 프로세스를 통해 복제 서버 간 데이터 차이를 발견하고 최신화를 진행한다. 특정 순서로 쓰기를 복사하기 때문에 상당한 지연이 발생할 수 있다.

**안티 엔트로피와 읽기 복구의 차이점**

- 안티 엔트로피는 값을 읽지 않아도 백그라운드 프로세스가 자동으로 데이터 최신화를 진행함
- 읽기 복구의 경우 무조건 오랜된 데이터를 읽어야지만 최신화의 필요성을 인지함

### 읽기 쓰기 정족수

- n : 복제 서버의 개수
- w : 쓰기가 성공한 노드
- r : 읽기를 진행하는 노드
- w + r > n 이 성립해야 무조건 하나 이상의 최신값을 얻을 수 있다

보통 n을 홀수로 지정해서 w = r = (n+1) / 2로 설정한다


### 최신성 모니터링
 
- 리더 기반 복제는 복제 지연에 대한 지표를 얻을 수 있다 -> 쓰기가 적용되는 순서가 정해져있음
- 리더 없는 복제는 복제 지연에 대한 지표를 얻기가 힘들다 -> 쓰기가 적용되는 순서가 정해져있지 않음

**느슨한 정족수**

장애가 발생한 상황에서 정족수 구성에 포함되지 않은 노드에 일단 쓰기 작업을 진행하는 것

느슨한 정속수는 쓰기 가용성을 높이는데 유용함. 정족수가 보장되는 것 처럼 보여도 실제 무조건 최신값을 읽는다는 보장은 없다 n개 이외의 노드가 포함되어 있기 때문임

### 동시 쓰기 감지 (갱신 손실)

동시성의 기준
- 각 작업이 서로에 대해서 알지 못하는 상태라면 발생 시간과 상관없이 동시 발생
- 작업이 서로에게 의존관계가 있거나 서로를 기반으로 한다면 그건 순차 발생







