## 저장소와 검색

가장 간단한 데이터베이스 : bash 함수로 구현

```shell
db_set(){
  echo "$1,$2" >> database
}

db_get(){
  grep "^$," database | sed -e "s/^$`,//`" | tail -n 1
}
```

- 파일 추가 속도 : 로그 형태이기 때문에 뒤에 붙여 쓰기만 하면 됨 -> O(1)
- 파일 검색 속도 : 특정 키 값이 어디에 위치하는지 전체 데이터를 다 뒤져야함 -> O(n)

> 효율적인 검색을 위해서는 색인이 필요하다

### 색인 (인덱스)

- 색인을 사용하면 검색 속도를 향상 시킬 수 있음
- 쓰기 속도를 지연시킴

색인은 쓰기 속도를 늦추기 때문에 보통 개발자가 수동으로 색인의 적용을 선택하도록 한다

### 해시 색인

키-값 저장소에서 색인은 인메모리 해시에 딕셔너리 형태로 저장 가능하다. 키와 파일의 바이트 오프셋을 해시 맵에 매핑할 수 있다
-> 키를 파일 오프셋에 매핑한 자체 인메모리 해시 테이블

파일에 항상 로그로써 추가를 하다보면 디스크 공간이 부족해질 수 있다. 이때는 특정 세그먼트로 로그를 나눌 수 있다.

세그먼트가 특정 크기에 도달하면 해당 세그먼트 파일을 닫고, 새로운 세그먼트 파일에 쓰기를 진행한다.

세그먼트 파일들에 대해서 중복 키를 버리고 최신 값만 유지하는 컴팩션 진행할 수 있다.

### 추가 전용 로그의 장점

- 추가와 세그먼트 병합은 순차 쓰기 작업이여서 랜덤 쓰기 작업보다 빠르다
- 세그먼트 파일은 추가 전용이거나 불변이라서 동시성과 고장 복구가 빠르다
- 오래된 세그먼트 병합은 조각화되는 데이터 파일 문제 피하게 해줌

### SS 테이블과 LSM 트리

키로 정렬된 형식 -> Sorted String Table -> SS 테이블

SS 테이블이 해시 색인을 가지는 로그 세그먼트에 비해 가지는 장점

LSM 트리
- 멤테이블에서 최신 데이터를 찾고, 거기 없으면 SS 테이블의 최신 세그먼트 다음 세그먼트를 계속 확인하고 없다면 마지막 세그먼트 까지 간다
- 블룸 필터를 사용하면 굳이 마지막 세그먼트 까지 가지 않더라도 키가 없다는걸 알려준다

LSM 트리의 기본 개념
- 백그라운드에서 연쇄적으로 SS 테이블을 병합하는 것
- 디스크 쓰기는 순차적이여서 높은 쓰기 처리량 가짐
- 정렬된 순서를 유지하기에 범위 질의 가능

B-Tree

- 키로 정렬된 키-값 쌍을 유지한다. 
- 키 값 검색과 범위 질의에 유리하다


### b-tree 최적화

- 트리에서 리프 노드들이 형제 노드에 대한 링크드 리스트를 가지면 순차 검색을 할때 부모 노드로 다시 올라갈 필요 없다 -> b+tree
- 페이지에 전체 키를 저장하는 것이 아니라 축약해서 저장한다. 키 크기를 줄이면 한 페이지에 더 많은 키가 들어가고 그러면 분기계수가 커져서 높이가 낮아진다. 보통 n개의 키가 있을때 높이는 o(logN)이다. 보통 아무리 데이터 맣아도 3,4층 안넘억마 

### b-tree와 lsm 트리 차이

- lsm 트리가 쓰기에 더 빠르다
- b-tree는 읽기에 빠르다


### 모든 것을 메모리에 보관
복구를 위한 로그만 디스크에 저장하고 나머지는 모두 메모리에서 운영한다. 램 가격이 낮아지고, 용량도 커지면서 가능해졌다. 
안티 캐싱 방법을 통해 메모리 공간이 부족하면 DB로 내리고, 나중에 다시 올릴 수 있다. 

### 데이터를 데이터 분석에 사용

특징 : 많은 데이터를 스캔해서 일부 컬럼만 읽어서 집계 처리를 해야 한다.
이때의 특징을 온라인 분석 처리 OLAP라고 한다 

트랜잭션의 특성
- 질의당 적은 수의 레코드 , 키 기준 가져옴
- 임의 접근 , 사용자 입력을 낮은 지연 시간으로 기록
- 데이터의 최신 상태 사용
- 기가 바이트에서 테라바이트

분석 시스템 특성
- 많은 레코드에 대한 집계
- 대규모 벌크 연산, 이벤트 스트림
- 시간이 지나며 일어난 이벤트 이력

데이터 웨어하우스
- OLTP 데이터베이스에 대해 분석 질의를 시행하면 트랜잭션에 의해서 동시 실행 트랜잭션들의 성능을 저하시킬 수 있다
- 데이터 웨어하우스는 회사 내 모든 OLTP 시스템에 있는 데이터의 읽기 전용 복사본임
- 주기적으로 OLTP 데이터베이스에서 데이터를 퍼오고, 이를 분셕에 적합한 스키마로 변경 -> 정제 후 데이터 웨어하우스에 적재

### OLTP 데이터베이스와 데이터 웨어하우스의 차이점

많은 데이터 웨어하우스는 별 모양 스키마라고 알려진 방법을 사용한다.

### 컬럼 지향 저장소
- 데이터 분석에 있어서 로우의 모든 값을 필요로 하지 않는다는 전제를 가지고 있다
- 실제로는 3개의 컬럼만 필요한데 100개의 컬럼을 모두 가져와야 한다면 성능상 손해이다
- 몇 백개의 전체 로우를 같이 저장하는 것이 아니라, 컬럼 별로 데이터를 다른 파일에 저장한다.
- 각 컬럼 파일의 순서를 같음이 보장되야 한다. 그래야 나중에 다시 합칠 수 있다.
