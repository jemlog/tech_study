## TCP 흐름 제어와 오류 제어

### TCP의 흐름 제어

TCP 연결에서 보통 수신측의 처리 속도보다 송신측의 송신 속도가 더 빠르면 문제가 생긴다. 수신측이 처리하는 동안 요청은 수신측의 수신 버퍼에 쌓이게 되고 버퍼가 꽉차면 마지막에 들어오려는 데이터는 폐기처분 된다.

따라서 송신측은 수신측의 데이터 처리 속도가 얼마인지 미리 파악하고 그에 맞는 양의 데이터를 전송해야 한다. 수신측은 자신이 처리할 수 있는 양을 의미하는 윈도우 크기를 응답 헤더에 담아서 송신측에 전달한다. 


### TCP 필수 용어

RTT (Round Trip Time)
- 송신측과 수신측으로 데이터가 왕복하는데 걸리는 시간, SYN와 SYN+ACK 간의 시간을 측정한다.

MTU (Maximum Transmission Unit)
- 한번에 보낼 수 있는 최대 단위
- 기본 1500 bytes

MSS (Maximum Segment Size)
- 한번에 보낼 수 있는 순수 데이터 크기
- MTU - IP 헤더 - TCP 헤더 = 1460 bytes
### Sliding Window

오늘날의 TCP는 보통 슬라이딩 윈도우 방식을 사용해서 흐름 제어를 구현한다. 송신측은 매번 데이터 전송이 가능한지 체크할 필요 없이, 수신측의 윈도우 사이즈를 알고 있다면 매번 송신 버퍼에서 윈도우 크기 만큼 데이터를 전송하면 된다.

송신측의 윈도우 크기는 3-way handshake 과정에서 결정된다. 

송신측은 처음 SYN를 보내고 수신측으로부터 SYN+ACK를 받기까지의 시간을 측정하고 (RTT), 이를 통해서 네트워크 상황 유추한다. 윈도우 크기는 차후 네트워크 상황에 따라 유동적으로 변경된다.

윈도우 크기만큼 전송 후, 수신측으로부터 남은 버퍼공간을 기반으로한 윈도우 사이즈 정보를 받으면 그만큼 window를 밀어서 데이터를 전송시킨다.

> 송신측의 윈도우 사이즈가 결정된 뒤, 수신 측은 매번 얼마의 데이터를 보내면 되는지 알려준다. 그러면 초기 윈도우 사이즈 내에서 계속 윈도우를 넘겨가며 버퍼 내의 데이터를 보낸다. 만약 전송 가능 데이터가 계속 많아지면 네트워크 상황이 좋은 것이므로 윈도우 크기 슬슬 키우면 된다. 

### 오류 제어

TCP는 기본적으로 ARQ 기반 오류 제어 사용한다. 보통 이 재전송 과정을 줄이기 위한 방법들을 추가로 사용한다.

수신측이 NACK을 보내는 방법과 ACK의 도착 유무로 판단하는 방법이 있다. 보통은 ACK을 사용한다.

오류가 날 수 있는 3가지 상황
- 송신측이 보낸 데이터가 중간에 유실되어 수신측이 ACK을 안보내는 경우
- 수신측이 ACK을 보냈지만 ACK이 중간에 유실되는 경우
- 송신측이 중복된 ACK를 받는 경우

### 오류 제어 방법 2가지

Go Back N

데이터를 연속적으로 보내다가 어느 데이터부터 오류가 발생했는지 검사하는 방법

1. 연속된 데이터를 보낸다.
2. 다 성공적으로 도착했으면 ACK 보냄
3. 만약 중간에 하나라도 유실됐으면 수신측은 그 유실된 데이터 이후의 데이터를 모두 다 버리고 송신측에 어디부터 유실됐는지 알려줌
4. 송신측은 그 유실된 데이터부터의 데이터를 다시 보냄

Selective Repeat

Go Back N과 반대로 유실된 데이터만 다시 보내는 방식이다. 선택적으로 재전송 할 수 있기에 효율적이라는 장점이 있지만, 새 데이터를 보내면 별도의 재정렬 과정을 거쳐야 한다는 단점이 있다. 

> 재전송이 이득인 상황에서는 Go Back N을 재정렬이 유리한 상황에서는 Selective Repeat을 사용하면 된다.