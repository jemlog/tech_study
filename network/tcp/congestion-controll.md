## TCP 혼잡 제어

---

네트워크 환경에서 통신 오류가 발생할 경우 기본적인 복구 방식은 재시도이다. 하지만 혼잡상황에서 재시도가 많아지면 혼잡도를 더욱 증가시킬 수 있다. 따라서 혼잡상황에서 송신측은 데이터의 전송량을 유동적으로 조절할 수 있어야 한다.


송신 측은 자신의 최종 윈도우 크기를 정할 때 수신 측이 보내준 윈도우 크기인 수신자 윈도우(RWND), 그리고 자신이 네트워크의 상황을 고려해서 정한 윈도우 크기인 혼잡 윈도우(CWND) 중에서 더 작은 값을 사용한다.

혼잡 윈도우 크기 초기화하기

- MSS : 한 세그먼트에 최대로 보낼 수 있는 데이터의 양을 나타내는 값
- MTU(Maximum Transmission Unit) : 한번 통신 때 보낼 수 있는 최대 단위

MSS = MTU - (IP헤더길이 + IP옵션길이) - (TCP헤더길이 + TCP옵션길이)

- TCP 환경에서 기본적인 MTU 크기 : 1500 bytes
- MSS = 1500 - 40 = 1460 Bytes
- 초기 혼잡 위도우 크기 == 1MSS


가장 기본적인 혼잡 제어 방법
- AIMD
- Slow Start

AIMD (Additive Increase / Multicative Decrease)

네트워크가 문제가 없을때는 혼잡 윈도우의 크기를 1씩 증가시킴

중간에 데이터가 유실되거나 응답이 오지 않는 등의 혼잡 상태 감지되면 혼잡 윈도우 크기를 반으로 줄임

이 방식은 네트워크에 늦게 참여하는 노드에게 유리

- 이미 대역폭을 많이 사용하고 있는 노드는 혼잡 제어를 통해 윈도우 크기를 반으로 줄일 확률이 높음
- 새로 들어온 노드는 남은 대역폭을 사용해서 본인은 혼잡 윈도우 크기 줄일 수 있다.

AIMD의 문제점 : 현대의 네트워크는 대역폭이 넉넉하다. 하지만 이 방식은 윈도우 크기를 너무 작게 키우기 때문에 네트워크의 대역폭을 제대로 사용하지 못한다.


Slow Start

네트워크 대역폭을 제대로 활용하지 못하는 AIMD 방식을 대신해서 윈도우 크기 증가 시 지수적으로 증가시키는 Slow Start 방식이 있다.

- 네트워크 여유로울 시 : 지수적으로 윈도우 크기를 증가
- 혼잡 감지 시 : 윈도우 크기를 1로 줄여버린다

최근의 TCP 에서 사용하는 Tahoe나 Reno가 AIMD와 Slow Start를 적절히 섞어서 사용한다.


혼잡 제어 정책 종류

3 ACK Duplicated 
수신측은 데이터를 처리한 후, ACK와 함께 다음으로 어떤 순서의 패킷이 필요한지를 보내는데 특정 패킷이 늦게 도착할 수 있으므로, 2번 정도는 중복으로 올 수도 있다. 

TCP는 현재까지 누적된 정상 데이터 중 가장 마지막 데이터에 대한 승인 번호를 보내주는 누적 승인 방식(Cumulative Acknowledgement)를 사용하기 때문에, 송신 측이 같은 승인 번호를 계속 중복해서 받는다면 해당 데이터까지는 정상적으로 전송되었으나 그 이후부터는 뭔가 문제가 발생했다고 알 수 있는 것이다.

Go back N이나 Selective Repeat과 같은 오류 제어 방식에 따라서 다음에 어떤 패킷부터 보내줘야하는지 알려줄 것이다.

이런 상황일 경우, 송신 측은 자신이 설정한 타임아웃 시간이 지나지 않았어도 바로 해당 패킷을 재전송할 수 있는데, 이 기법을 빠른 재전송(Fast Transmit)이라고 한다.

Threshold : 이 라인까지만 slow start, 이후에는 aimd 방식이다. 

지수적으로 계속 늘어나면 제어도 힘들도, 혼잡 상황에서는 조금씩 증가시키는게 안전함

송신 측은 본격 통신 전에 ssthresh 값을 자신의 혼잡 윈도우 절반 크기인 0.5 mss로 초기화한다.

tahoe 

3 ack duplicate나 timeout 발생하면 1로 줄여버린다.

혼잡 상황에서의 문제가 발생했을때의 혼잡 윈도우 크기의 반을 딱 ssthreshold로 다시 잡는다

단점 : 초반 slow start 구간에 키우는데 너무 오래 걸림
윈도우 크기 1부터 다시 키워야함

tcp reno

3 ack duplicated는 aimd로 줄이고 ssthreshold도 거기에 맞게 줄인다.

timeout은 1로 줄이되 ssthreshold를 반으로 줄이지 않는다.

