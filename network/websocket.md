## Websocket

웹소켓은 ws 프로토콜을 기반으로 클라이언트와 서버 사이에 지속적인 완전 양방향 연결 스트림을 만들어 주는 기술입니다.

### 기존 HTTP를 사용한 실시간 통신 구현 방법

**1. Polling**

클라이언트가 주기적으로 서버에게 데이터를 요청하는 방식을 말한다. 데이터 업데이트 주기가 불분명한 경우, 불필요한 요청으로 인한 부하가 커진다.

**2. Long Polling**

클라이언트가 서버와 연결한 후, 서버 단에서 데이터가 업데이트 될때까지 연결을 유지한다. 만약 데이터가 업데이트 되면 클라이언트로 데이터를 전달한 후 연결을 끊고, 즉시 새로운 요청을 클라이언트로 보낸다.

주로 소규모 실시간 통신 서비스에서 사용된다.

**3. Streaming**

클라이언트가 한번 서버에 연결한 뒤에 계속 이벤트가 발생할때마다 데이터를 전송 받는 기법이다. 실시간으로 데이터를 전달할 수 있고, 불필요한 요청이 발생하지 않지만 단방향 통신만 제공한다.

> 실시간, 양방향 연결 서비스를 제공하기 위해 웹소켓 기술이 사용된다.

### 웹소켓의 동작 방식

웹소켓은 완전한 양방향 통신 (Full Duplex)을 제공한다

- Half Duplex : 양방향 통신이지만 한번에 한쪽만 데이터 전송 가능하다. ex 무전기
- Full Duplex : 한번에 양쪽에서 모두 데이터를 전송할 수 있다.

**웹소켓 동작 순서**

1. 기존 HTTP 핸드쉐이킹 과정을 거쳐서 연결을 맺는다
2. 연결이 생성되면 HTTP 프로토콜에서 ws 프로토콜로 변환한다
3. 웹소켓을 위한 소켓 생성 후 전이중 통신 진행한다

**웹소켓 방식의 장점**

- HTTP의 경우 매 요청마다 핸드셰이크 과정을 거쳐야 하지만, 웹소켓은 한번만 핸드셰이크를 하면 되므로 응답 시간이 줄어든다.
- HTTP 요청을 사용함으로 80 포트와 443 포트 사용 가능하고 HTTP 기능 그대로 사용 가능하다.

### 웹 소켓 관련 고민해볼 주제 

<details>
<summary>모바일 환경에서의 웹소켓</summary>
<div markdown="1">

모바일 환경은 데스크탑 웹 환경과 다르게 실시간으로 네트워크 연결 상태가 변한다. 사용자의 이동에 따라 다른 와이파이를 쓰기도 하고 LTE로 전환할수도 있다. 
이때 네트워크가 변동되면 클라이언트 쪽에서는 연결을 끊어버린다. 하지만 강제 종료 즉, 4-way handshake 과정을 거치지 않았기 때문에 서버측에서는 연결이 종료된걸 알지 못한다.

따라서 서버에서 데이터를 보내더라도 클라이언트는 데이터를 받지 못한다. 특히 서버가 데이터를 전송했다고 판단하는 기준은 송신 버퍼에 데이터를 썼는지 여부임으로, 클라이언트가 데이터를 받지 않더라도 서버는 성공으로 판단할 수 있다. 따라서 서버는 클라이언트와의 웹 소켓 연결을 주기적으로 확인하기 위한 수단이 필요하다. 
이때 대표적인 방법이 주기적으로 서버와 클라이언트가 health를 체크하는 **ping-pong** 방식이다.

</div>
</details>

<details>
<summary>실시간 통신에서는 웹소켓만으로 충분한가</summary>
<div markdown="1">


웹소켓이 실시간 양방향 통신의 가장 좋은 방법이지만, 웹소켓 통신에 문제가 생길 수 있다. 이때를 대비에서 HTTP 기반 Polling 방식의 실시간 데이터 처리 방식도 차선책으로 만들어놔야 한다.
</div>
</details>


### 대규모 시스템 설게 - 채팅 시스템 설계

중요 사항
- 어떤 종류의 채팅 앱을 설계 하는지 여부가 중요하다
- 일대일 채팅앱 vs 그룹 채팅앱

고려해야 하는 사항
- 일대일 채팅앱의 경우 레이턴시가 낮아야 한다. 
- 그룹 채팅일 경우 최대 참여자 수가 필요하다. 
- 접속 상태 체크도 중요한 사항이다. 
- 하나의 계정 다른 기기 동접 여부

### 실시간 서비스 구현 방식

polling

long polling

클라이언트가 새 메세지가 반환되거나 타임아웃 될때까지 연결을 유지하는 방식이다. Polling 방식에 비해서는 필요없는 커넥션 재연결 과정이 줄어들 수 있다.
하지만, 다수의 서버를 운영하는 환경에서 송신 클라이언트가 메세지를 보내는 서버와 수신 클라이언트와 롱폴링을 맺고 있는 서버가 다를 수 있다. 

하나의 서버로 커넥션을 다 유지할 경우

커넥션 마나 일정량의 서버 메모리가 필요하다 따라서 메모리만 충분하다면 하나의 서버로도 커넥션 다 받을 수 있다. 하지만 하나의 서버만 운영하면 SPOF가 될 위험이 있다.

DB 고려

사용자 정보, 친구 목록, 설정 등은 안정성이 중요함으로 RDMBS에 저장하는게 좋다

반면 채팅 시스템의 경우 
- 채팅 이력 데이터 양이 너무 많음
- 1대1 채팅의 경우 읽기 쓰기 1대1
- 주로 최신 데이터들만 참조함

보통 채팅 서비스에서는 키-값 저장소를 많이 사용한다
- 수평적 규모 확장 유리함
- 접근 시간이 낮다
