## 조인




### 조인의 기본적인 종류

![스크린샷 2023-02-20 오전 10.06.27.png](/image/스크린샷%202023-02-20%20오전%2010.49.52.png)

inner join

- 드라이빙 테이블과 드리븐 테이블 공통으로 존재하는 데이터가 있을때만 조인한다


left outer join (outer join)

- 드라이빙 테이블 쪽의 모든 데이터를 포함한 조인을 진행한다. null 값이 많아질 수있음

right outer join

- 드리븐 테이블 쪽의 모든 데이터를 포함한 조인을 진행한다.

full outer join

- 양쪽의 모든 데이터를 보여준다

cross join

- 나올 수 있는 모든 경우의 수를 곱한다. N * M 의 개수가 나온다고 할 수 있다.


### 조인의 내부 동작 원리

조인 조건의 컬럼에 모두 인덱스가 있을때, 조인은 Nested Loop Join 방식으로 동작한다.

Nested Loop Join
- 코드에서 중첩 반복문을 돌리는 것과 비슷하다
- 드라이빙 테이블에서 조건에 만족하는 레코드를 순차 탐색한 뒤, 각각의 드라이빙 테이블 레코드에 연결될 드리븐 테이블의 레코드를 각각 탐색한다.
- 드라이빙 테이블에서 최대한 개수를 줄이는 것이 드리븐 테이블에 대한 디스크 I/O를 줄여준다.
- 만약 조인 조건에 인덱스가 걸려 있지 않다면, 드라이빙 테이블 레코드 각각에 일치하는 드리븐 테이블 레코드를 풀 테이블 스캔 해서 찾아야 한다.
- 만약 Nested Loop Join으로 동작할 조건을 충족하지 못하면, 해시 조인으로 동작한다.

Sort Merge Join
- 드라이빙 테이블에서 조인조건을 만족하는 행을 찾아 정렬
- 드리븐 테이블에서 조인조건을 만족하는 행을 찾아 정렬
- 정렬된 결과를 이용하여 조인

Hash Join 

각 테이블에 조인 조건 컬럼에 해시 함수 적용 

Join 순서

1. 빌드 : 조인 대상 테이블 중 레코드 수가 적은 것을 골라서 해시 테이블로 만든다.
2. 프로브 : 빌드 테이블로 해시 테이블 만들고 나면, 프로브 테이블을 스캔하면서 일치하는 레코드를 해시 테이블에서 찾아서 결과를 반환한다.
3. 해시 테이블은 조인 버퍼 사용해서 만든다.
4. 만약 메모리 넘어서면 해시 테이블 만들다가 멈추고 남은 테이블 레코드들을 디스크에 청크로 구분해서 저장해놓음
5. 전체 데이터의 일부분을 조인에 성공할때마다 디스크 청크에서 새로 불러와서 조인하고 이어붙인다.

청크 나눌 필요 없이 한번에 해결 가능하면 클래식 해시 조인을 사용하고, 여러번 나눠야 하면 그레이스 해시 조인 하이브리드로 사용한다.
- 장점: Nested Loop Join, Merge Join의 단점이 보완됨
- 단점: 해시함수와 메모리 사용 비용이 발생
- 드라이빙 테이블 데이터가 적을수록 성능이 좋음


### Hash Join vs Nested Loop Join

해시 조인 : 첫번째 레코드를 찾는데 오래 걸리지만, 최종까지는 얼마안걸림

네스티드 루프 조인 : 첫번째 레코드를 빨리 찾고, 최종까지는 느리게 도달함

- 해시 조인은 최고 스루풋

- 네스티드 루프 조인은 최고 응답 속도

OLTP 환경에서는 최고 응답 속도가 중요하고, 분석용 시스템에서는 스루풋이 중요하다.

따라서 상용으로 사용하는 MySQL은 주로 OLTP 환경에서 사용되기에 기본 조인 전략을 네스티드 루프 조인으로 채택했다. 만약 조인 조건 컬럼에 인덱스가 없을때 해시 조인을 사용한다.

