## 파티셔닝

### 파티셔닝이 필요한 이유

- 데이터셋이 매우 클때
- 질의 처리량이 매우 높을때
- 확장성을 위해서 파티셔닝을 진행


파티셔닝의 목적 : 데이터와 질의 부하를 노드 사이에 균등하기 분산하는 것

만약 균등하게 분배가 안되서 특정 노드가 데이터가 많거나 질의가 많이 들어온다면 skew 됐다고 말한다.

극단적인 상황에서는 10개 중 9개가 유휴 상태에 있고 1개가 질의를 다 받는 핫스팟 문제가 발생할 수 있다.

핫스팟 문제를 해결하는 가장 간단한 방법
- 무작위 배치 

단점 : 어떤 레코드가 어떤 노드에 배치됐는지 알지 못한다 → 모든 노드 다 뒤져야함

### 파티셔닝 방법


### 키 범위 기준 파티셔닝


각 파티션에 연속된 범위의 키를 할당하므로, 어떤 키가 어떤 파티션에 속하는지 쉽게 알 수 있다.

데이터 고르게 분산하기 위해서는 키 범위를 똑같이 할당하면 안되고 유동적으로 할당해야 한다.

- 장점 : 각 파티션 내에 키를 정렬된 상태로 저장 가능 → 범위 검색이 가능하다

- 단점 : 특정 접근 패턴이 핫스팟 유발할 수 있다.

만약 시간 단위로 키를 나눴을때 쓰기 작업은 모두 최근 날짜 파티션으로 쏠리게 된다 → 과부하 발생

### 키의 해시값 기준 파티셔닝

쏠림과 핫스팟 문제로 인해 실제 분산 데이터스토어는 해시 함수를 사용한다.

해시값을 구한 다음, 각 파티션에 해시값 범위를 지정한다. 범위에 해당하는 해시값을 할당해주면 된다.

- 단점 : 범위 질의를 할 수 없게 된다.

- 장점 : 핫스팟 제거에 도움이 된다. 하지만 완전히 제거는 불가능하다. Ex 유명인 검색

몽고 db에서는 해시 파티셔닝 사용하면 범위 질의가 모든 파티션에 대해서 이뤄져야 한다.

### 파티셔닝과 보조 색인

인덱스가 있는 데이터베이스를 파티셔닝하는 건 고려해야할 사항들이 있다.

### 문서 기반 파티셔닝

몽고DB, 엘라스틱 서치 등등 문서 기반 색인 파티셔닝 사용한다.

각 파티션이 자신만의 보조 인덱스를 가지도록 한다. (지역색인)

### 용어 기반 파티셔닝

전역적인 인덱스를 가진다

용어 자체를 사용하면 범위 스캔 가능, 용어의 해시값을 사용해 파티셔닝하면 부하가 고르게 분산

- 장점 : 읽기가 효율적이다. 모든 파티션에 스캐터 개터 할 필요 없이 원하는 용어를 포함하는 파티션으로만 요청 보내면 됨

- 단점 : 쓰기가 느리고 복잡하다

현실에서 전역 보조 색인은 비동기로 갱신됨

### 파티션 재균형화 방법

- 쓰면 안되는 방법 : 해시값에 mod 연산

    - 노드를 추가할때마다 파티션이 저장되는 노드가 변경되므로 재균형화 비용 커짐

### 고정 파티셔닝 VS 동적 파티셔닝

- 고정 파티셔닝을 하면 그 고정값에 대한 수치를 정확히 알기 어렵고, 오버헤드가 생길 수 있다.

- 동적 파티셔닝을 사용하면 전체 데이터셋의 크기에 맞춰서 동적으로 파티션 개수가 정해진다.

### 완전 자동 재균형화 VS 수동 재균형화

- 수동으로 재균형화 하는게 안정적임


### 파티션에 대한 라우팅 방법

1. 가쉽 프로토콜을 통해서 일단 무작위 노드로 요청 보내고, 아닐시 올바른 노드로 보내줌
2. 라우팅 계층으로 보내면 라우팅 계층이 올바른 곳으로 보냄
3. 클라이언트가 어느 노드에 원하는 데이터가 있는지 정확히 알고있음