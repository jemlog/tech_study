## 분산 락


여러 서버에서 공통적인 트랜잭션 처리를 하기 위해 분산 락을 사용할 수 있다. 하나의 서버에서 synchronized로 락을 걸면 다른 서버에서는 문제 없이 같은 데이터에 접근 가능하다. 여러 서버들이 공통적으로 사용할 수 있는 락을 위해 분산 락을 사용하고 레디스를 많이 사용한다.

가장 쉬운 구현 방법은 스핀 락을 사용하는 것이다.

스핀락은 락을 얻을때까지 계속 락 요청을 레디스에게 보내는 방법이다. 레디스의 Lettuce를 사용해서 setnx 명령어를 통해 구현할 수 있다.

setnx의 문제점 : 락을 기다리는 것과 락을 획득하는것이 원자적으로 연산되지만 타임아웃 설정 불가능하다. 과도한 트래픽을 방지하기 위해 락 획득시 최대 유지 기간이나 최대 허용 횟수 등을 정해줘야 한다.

스핀 락은 레디스에 엄청난 부담을 준다. 지속적으로 락획득을 시도하기 때문에 레디스를 계속 요청 받음

해결방법 : 레디스의 분산 락 라이브러리인 redisson 사용

### Redisson

- Non-blocking I/o 사용

- lock에 타임아웃 구현되어 있음

- 파라미터에 락 획득 대기 타임아웃과 락 만료 시간이 들어간다.
  - 두번째 파라미터 덕분에 한 쓰레드가 무한정 락을 들고있지 않는다

- 스핀 락 사용 안해서 레디스에 부담 안줌 -> Pub-Sub 구조 사용

Pub-Sub 구조 동작 방식

- 락이 해제될때 subscribe하는 클라이언트들에게 알림을 준다.

- 락 해제 메세지 올때까지 대기 -> 락 해제되었다고 하면 획득 시도 -> 실패하면 대기 -> 그러다가 타임아웃 되면 그냥 예외







참고 레퍼런스

- [분산락 하이퍼커넥트 자료](https://hyperconnect.github.io/2019/11/15/redis-distributed-lock-1.html)
- [우아한 형제들 MySQL 네임드 락 사용](https://techblog.woowahan.com/2631/)